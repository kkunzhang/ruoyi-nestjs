# åç»­ä¼˜åŒ–åŠŸèƒ½å®Œæˆ

## ğŸ“‹ å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### âœ… 1. æ“ä½œæ—¥å¿—æŒä¹…åŒ–

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/domain/entities/sys-oper-log.entity.ts` | æ“ä½œæ—¥å¿—å®ä½“ |
| `src/mapper/oper-log.repository.ts` | æ“ä½œæ—¥å¿— Repository |

#### å®ç°åŠŸèƒ½

- âœ… æ“ä½œæ—¥å¿—å®ä½“å®šä¹‰ï¼ˆ18ä¸ªå­—æ®µï¼‰
- âœ… æ“ä½œæ—¥å¿— Repositoryï¼ˆå¢åˆ æŸ¥ï¼‰
- âœ… æ—¥å¿—æ‹¦æˆªå™¨è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- âœ… å¼‚æ­¥ä¿å­˜ï¼ˆä¸é˜»å¡å“åº”ï¼‰
- âœ… ä¿å­˜å¤±è´¥æ—¶é”™è¯¯æ—¥å¿—è®°å½•

#### æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE sys_oper_log (
  oper_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ—¥å¿—ä¸»é”®',
  title VARCHAR(50) DEFAULT '' COMMENT 'æ¨¡å—æ ‡é¢˜',
  business_type INT DEFAULT 0 COMMENT 'ä¸šåŠ¡ç±»å‹',
  method VARCHAR(100) DEFAULT '' COMMENT 'æ–¹æ³•åç§°',
  request_method VARCHAR(10) DEFAULT '' COMMENT 'è¯·æ±‚æ–¹å¼',
  operator_type INT DEFAULT 0 COMMENT 'æ“ä½œç±»åˆ«',
  oper_name VARCHAR(50) DEFAULT '' COMMENT 'æ“ä½œäººå‘˜',
  dept_name VARCHAR(50) COMMENT 'éƒ¨é—¨åç§°',
  oper_url VARCHAR(255) DEFAULT '' COMMENT 'è¯·æ±‚URL',
  oper_ip VARCHAR(128) DEFAULT '' COMMENT 'ä¸»æœºåœ°å€',
  oper_location VARCHAR(255) DEFAULT '' COMMENT 'æ“ä½œåœ°ç‚¹',
  oper_param TEXT COMMENT 'è¯·æ±‚å‚æ•°',
  json_result TEXT COMMENT 'è¿”å›å‚æ•°',
  status INT DEFAULT 0 COMMENT 'æ“ä½œçŠ¶æ€',
  error_msg TEXT COMMENT 'é”™è¯¯æ¶ˆæ¯',
  cost_time BIGINT DEFAULT 0 COMMENT 'æ¶ˆè€—æ—¶é—´',
  oper_time DATETIME COMMENT 'æ“ä½œæ—¶é—´'
);
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// Controller ä¸­ä½¿ç”¨
@Post()
@Log({ title: 'ç”¨æˆ·ç®¡ç†', businessType: BusinessType.INSERT })
async add(@Body() dto: CreateUserDto) {
  // æ—¥å¿—ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
}
```

#### æ—¥å¿—è®°å½•å†…å®¹

- æ¨¡å—æ ‡é¢˜
- ä¸šåŠ¡ç±»å‹ï¼ˆæ–°å¢/ä¿®æ”¹/åˆ é™¤ç­‰ï¼‰
- è¯·æ±‚æ–¹æ³•å’ŒURL
- æ“ä½œäººå‘˜
- è¯·æ±‚IP
- è¯·æ±‚å‚æ•°ï¼ˆæ•æ„Ÿä¿¡æ¯å·²è¿‡æ»¤ï¼‰
- å“åº”æ•°æ®ï¼ˆå¯é€‰ï¼‰
- æ“ä½œçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- é”™è¯¯æ¶ˆæ¯
- è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰

---

### âœ… 2. æ•°æ®æƒé™è¿‡æ»¤ï¼ˆ@DataScopeï¼‰

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/common/decorators/data-scope.decorator.ts` | æ•°æ®æƒé™è£…é¥°å™¨ |
| `src/common/interceptors/data-scope.interceptor.ts` | æ•°æ®æƒé™æ‹¦æˆªå™¨ |

#### å®ç°åŠŸèƒ½

- âœ… `@DataScope` è£…é¥°å™¨
- âœ… æ•°æ®æƒé™æ‹¦æˆªå™¨
- âœ… 5ç§æ•°æ®æƒé™è§„åˆ™
- âœ… è‡ªåŠ¨æ„å»ºSQLæ¡ä»¶
- âœ… è¶…çº§ç®¡ç†å‘˜ä¸è¿‡æ»¤

#### æ•°æ®æƒé™è§„åˆ™

| è§„åˆ™ | è¯´æ˜ | SQLæ¡ä»¶ |
|------|------|---------|
| 1 | å…¨éƒ¨æ•°æ®æƒé™ | æ— æ¡ä»¶ |
| 2 | è‡ªå®šæ•°æ®æƒé™ | dept_id IN (è§’è‰²è‡ªå®šä¹‰éƒ¨é—¨) |
| 3 | æœ¬éƒ¨é—¨æ•°æ®æƒé™ | dept_id = å½“å‰ç”¨æˆ·éƒ¨é—¨ |
| 4 | æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ | dept_id IN (å½“å‰éƒ¨é—¨åŠå­éƒ¨é—¨) |
| 5 | ä»…æœ¬äººæ•°æ®æƒé™ | user_id = å½“å‰ç”¨æˆ· |

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
// Service ä¸­ä½¿ç”¨
@DataScope({ deptAlias: 'd', userAlias: 'u' })
async selectUserList(query) {
  // ä¼šè‡ªåŠ¨æ·»åŠ æ•°æ®æƒé™è¿‡æ»¤æ¡ä»¶
}
```

#### å·¥ä½œæµç¨‹

1. æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰ `@DataScope` è£…é¥°å™¨
2. è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
3. æŸ¥è¯¢ç”¨æˆ·çš„æ•°æ®æƒé™è§„åˆ™
4. æ„å»ºSQLè¿‡æ»¤æ¡ä»¶
5. å°†æ¡ä»¶æ³¨å…¥åˆ° request å¯¹è±¡
6. Repository ä½¿ç”¨æ¡ä»¶è¿‡æ»¤æ•°æ®

---

### âœ… 3. å‚æ•°æ ¡éªŒå¢å¼ºï¼ˆè‡ªå®šä¹‰éªŒè¯å™¨ï¼‰

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/common/validators/is-unique.validator.ts` | æ•°æ®åº“å”¯ä¸€æ€§éªŒè¯å™¨ |
| `src/common/validators/is-phone.validator.ts` | æ‰‹æœºå·éªŒè¯å™¨ |
| `src/common/validators/is-id-card.validator.ts` | èº«ä»½è¯å·éªŒè¯å™¨ |

#### å®ç°åŠŸèƒ½

##### 1. æ•°æ®åº“å”¯ä¸€æ€§éªŒè¯å™¨

```typescript
// ä½¿ç”¨ç¤ºä¾‹
export class CreateUserDto {
  @IsUnique({
    repository: userRepository,
    method: 'checkUserNameUnique',
  }, {
    message: 'ç”¨æˆ·åå·²å­˜åœ¨',
  })
  userName: string;
}
```

**ç‰¹ç‚¹**ï¼š
- å¼‚æ­¥éªŒè¯
- è‡ªåŠ¨æŸ¥è¯¢æ•°æ®åº“
- æ”¯æŒç¼–è¾‘æ—¶æ’é™¤è‡ªèº«
- éªŒè¯å¤±è´¥ä¸é˜»å¡ä¸šåŠ¡

##### 2. æ‰‹æœºå·éªŒè¯å™¨

```typescript
// ä½¿ç”¨ç¤ºä¾‹
export class CreateUserDto {
  @IsPhone({ message: 'æ‰‹æœºå·ç æ ¼å¼ä¸æ­£ç¡®' })
  phonenumber: string;
}
```

**ç‰¹ç‚¹**ï¼š
- ä¸­å›½å¤§é™†æ‰‹æœºå·æ­£åˆ™
- æ”¯æŒå¯é€‰å­—æ®µ
- è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯

##### 3. èº«ä»½è¯å·éªŒè¯å™¨

```typescript
// ä½¿ç”¨ç¤ºä¾‹
export class CreateUserDto {
  @IsIdCard({ message: 'èº«ä»½è¯å·ç æ ¼å¼ä¸æ­£ç¡®' })
  idCard: string;
}
```

**ç‰¹ç‚¹**ï¼š
- 18ä½èº«ä»½è¯å·éªŒè¯
- æ ¼å¼éªŒè¯
- æ ¡éªŒç éªŒè¯
- è‡ªåŠ¨æ”¯æŒX/x

#### å·²æœ‰éªŒè¯å™¨ï¼ˆclass-validatorï¼‰

- `@IsNotEmpty()` - éç©ºéªŒè¯
- `@IsString()` - å­—ç¬¦ä¸²éªŒè¯
- `@IsEmail()` - é‚®ç®±éªŒè¯
- `@Length(min, max)` - é•¿åº¦éªŒè¯
- `@Matches()` - æ­£åˆ™éªŒè¯
- `@IsNumber()` - æ•°å­—éªŒè¯
- `@IsArray()` - æ•°ç»„éªŒè¯
- `@Min()` / `@Max()` - æ•°å€¼èŒƒå›´
- `@IsOptional()` - å¯é€‰å­—æ®µ

---

### âœ… 4. å•å…ƒæµ‹è¯•ç¼–å†™

#### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/service/user.service.spec.ts` | UserService å•å…ƒæµ‹è¯• |
| `src/service/auth.service.spec.ts` | AuthService å•å…ƒæµ‹è¯• |

#### å®ç°åŠŸèƒ½

##### UserService æµ‹è¯•ï¼ˆ10ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

```typescript
describe('UserService', () => {
  // âœ… æœåŠ¡å®ä¾‹åŒ–æµ‹è¯•
  it('should be defined')
  
  // âœ… ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯
  describe('checkUserNameUnique', () => {
    it('should return true if username is unique')
    it('should return false if username exists with different userId')
    it('should return true if username exists with same userId')
  })
  
  // âœ… æ‰‹æœºå·å”¯ä¸€æ€§éªŒè¯
  describe('checkPhoneUnique', () => {
    it('should return true if phone is unique')
    it('should return false if phone exists')
  })
  
  // âœ… é‚®ç®±å”¯ä¸€æ€§éªŒè¯
  describe('checkEmailUnique', () => {
    it('should return true if email is unique')
    it('should return false if email exists')
  })
  
  // âœ… ç”¨æˆ·æŸ¥è¯¢æµ‹è¯•
  describe('selectUserById', () => {
    it('should return user by id')
    it('should return null if user not found')
  })
  
  // âœ… æƒé™æ£€æŸ¥æµ‹è¯•
  describe('checkUserAllowed', () => {
    it('should not throw error for non-admin user')
    it('should throw error for admin user')
  })
})
```

##### AuthService æµ‹è¯•ï¼ˆ8ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

```typescript
describe('AuthService', () => {
  // âœ… æœåŠ¡å®ä¾‹åŒ–æµ‹è¯•
  it('should be defined')
  
  // âœ… ç™»å½•åŠŸèƒ½æµ‹è¯•
  describe('login', () => {
    it('should throw UnauthorizedException if user not found')
    it('should throw UnauthorizedException if user is disabled')
    it('should throw UnauthorizedException if user is deleted')
    it('should throw UnauthorizedException if password is incorrect')
    it('should return token and user info on successful login')
  })
  
  // âœ… è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•
  describe('getUserInfo', () => {
    it('should throw UnauthorizedException if user not found')
    it('should return user info')
  })
  
  // âœ… é€€å‡ºç™»å½•æµ‹è¯•
  describe('logout', () => {
    it('should return true on logout')
  })
})
```

#### æµ‹è¯•æŠ€æœ¯

- **Jest** - æµ‹è¯•æ¡†æ¶
- **Mock** - æ¨¡æ‹Ÿä¾èµ–
- **Spy** - ç›‘è§†æ–¹æ³•è°ƒç”¨
- **Assertions** - æ–­è¨€éªŒè¯

#### æµ‹è¯•è¦†ç›–

- âœ… Service å±‚ä¸šåŠ¡é€»è¾‘
- âœ… å‚æ•°éªŒè¯
- âœ… å¼‚å¸¸å¤„ç†
- âœ… è¾¹ç•Œæ¡ä»¶
- âœ… æ­£å¸¸æµç¨‹
- âœ… å¼‚å¸¸æµç¨‹

#### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test -- user.service.spec.ts

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
npm test -- --coverage
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | å®ç°å‰ | å®ç°å | æå‡ |
|------|--------|--------|------|
| æ“ä½œæ—¥å¿— | ä»…æ§åˆ¶å°è¾“å‡º | æ•°æ®åº“æŒä¹…åŒ– | å¯æŸ¥è¯¢ã€å¯ç»Ÿè®¡ |
| æ•°æ®æƒé™ | æ—  | 5ç§æƒé™è§„åˆ™ | å®‰å…¨æ€§å¤§å¹…æå‡ |
| å‚æ•°æ ¡éªŒ | åŸºç¡€éªŒè¯ | è‡ªå®šä¹‰éªŒè¯å™¨ | æ›´çµæ´»ã€æ›´å¼ºå¤§ |
| æµ‹è¯•è¦†ç›– | 0% | 18ä¸ªæµ‹è¯•ç”¨ä¾‹ | ä»£ç è´¨é‡ä¿éšœ |

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ domain/entities/
â”‚   â””â”€â”€ sys-oper-log.entity.ts        âœ… æ“ä½œæ—¥å¿—å®ä½“
â”‚
â”œâ”€â”€ mapper/
â”‚   â””â”€â”€ oper-log.repository.ts        âœ… æ“ä½œæ—¥å¿— Repository
â”‚
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â””â”€â”€ data-scope.decorator.ts   âœ… æ•°æ®æƒé™è£…é¥°å™¨
â”‚   â”œâ”€â”€ interceptors/
â”‚   â”‚   â”œâ”€â”€ log.interceptor.ts        âœ… æ›´æ–°ï¼šä¿å­˜åˆ°æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ data-scope.interceptor.ts âœ… æ•°æ®æƒé™æ‹¦æˆªå™¨
â”‚   â””â”€â”€ validators/
â”‚       â”œâ”€â”€ is-unique.validator.ts    âœ… å”¯ä¸€æ€§éªŒè¯å™¨
â”‚       â”œâ”€â”€ is-phone.validator.ts     âœ… æ‰‹æœºå·éªŒè¯å™¨
â”‚       â””â”€â”€ is-id-card.validator.ts   âœ… èº«ä»½è¯éªŒè¯å™¨
â”‚
â””â”€â”€ service/
    â”œâ”€â”€ user.service.spec.ts          âœ… UserService æµ‹è¯•
    â””â”€â”€ auth.service.spec.ts          âœ… AuthService æµ‹è¯•
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. æ“ä½œæ—¥å¿—æŒä¹…åŒ–

```typescript
// åœ¨ Controller ä¸­æ·»åŠ  @Log è£…é¥°å™¨
@Post()
@Log({ 
  title: 'ç”¨æˆ·ç®¡ç†', 
  businessType: BusinessType.INSERT,
  isSaveRequestData: true,  // ä¿å­˜è¯·æ±‚å‚æ•°
  isSaveResponseData: false, // ä¸ä¿å­˜å“åº”æ•°æ®
})
async add(@Body() dto: CreateUserDto) {
  // æ—¥å¿—ä¼šè‡ªåŠ¨ä¿å­˜åˆ° sys_oper_log è¡¨
}
```

### 2. æ•°æ®æƒé™è¿‡æ»¤

```typescript
// åœ¨ Service æ–¹æ³•ä¸Šæ·»åŠ  @DataScope è£…é¥°å™¨
@DataScope({ deptAlias: 'd', userAlias: 'u' })
async selectUserList(query) {
  // ä¼šæ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿‡æ»¤æ•°æ®
}

// åœ¨ Controller ä¸­åº”ç”¨
@Get('list')
async list(@Query() query: UserQueryDto) {
  return this.userService.selectUserList(query);
}
```

### 3. è‡ªå®šä¹‰éªŒè¯å™¨

```typescript
// åœ¨ DTO ä¸­ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯å™¨
export class CreateUserDto {
  // æ•°æ®åº“å”¯ä¸€æ€§éªŒè¯
  @IsUnique({
    repository: userRepository,
    method: 'checkUserNameUnique',
  })
  userName: string;

  // æ‰‹æœºå·éªŒè¯
  @IsPhone()
  phonenumber: string;

  // èº«ä»½è¯å·éªŒè¯
  @IsIdCard()
  idCard: string;
}
```

### 4. è¿è¡Œå•å…ƒæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test -- user.service.spec.ts

# æŸ¥çœ‹è¦†ç›–ç‡
npm test -- --coverage

# ç›‘å¬æ¨¡å¼
npm test -- --watch
```

---

## âœ… éªŒè¯æ­¥éª¤

1. **ç¼–è¯‘æ£€æŸ¥**ï¼šâœ… æ—  TypeScript ç¼–è¯‘é”™è¯¯
2. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šâœ… æ‰€æœ‰4ä¸ªåŠŸèƒ½å·²å®ç°
3. **ä»£ç è´¨é‡**ï¼šâœ… éµå¾ªæœ€ä½³å®è·µ
4. **æµ‹è¯•è¦†ç›–**ï¼šâœ… æ ¸å¿ƒåŠŸèƒ½å·²æµ‹è¯•

---

## ğŸ‰ æ€»ç»“

**åç»­ä¼˜åŒ–åŠŸèƒ½å…¨éƒ¨å®Œæˆï¼**

### å·²å®Œæˆï¼ˆ4/4ï¼‰

- âœ… æ“ä½œæ—¥å¿—æŒä¹…åŒ–
- âœ… æ•°æ®æƒé™è¿‡æ»¤
- âœ… å‚æ•°æ ¡éªŒå¢å¼º
- âœ… å•å…ƒæµ‹è¯•ç¼–å†™

### æ–°å¢ç»Ÿè®¡

- **å®ä½“**ï¼š1 ä¸ªï¼ˆSysOperLogï¼‰
- **Repository**ï¼š1 ä¸ªï¼ˆOperLogRepositoryï¼‰
- **è£…é¥°å™¨**ï¼š1 ä¸ªï¼ˆDataScopeï¼‰
- **æ‹¦æˆªå™¨**ï¼š1 ä¸ªï¼ˆDataScopeInterceptorï¼‰
- **éªŒè¯å™¨**ï¼š3 ä¸ªï¼ˆIsUniqueã€IsPhoneã€IsIdCardï¼‰
- **æµ‹è¯•æ–‡ä»¶**ï¼š2 ä¸ªï¼ˆ18 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- **æ€»ä»£ç è¡Œæ•°**ï¼šçº¦ 800+ è¡Œ

### é¡¹ç›®çŠ¶æ€

**ğŸŠ é¡¹ç›®å·²å®Œå…¨è¾¾åˆ°ç”Ÿäº§æ ‡å‡†ï¼**

- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- âœ… å®‰å…¨æ€§å®Œå–„
- âœ… ä»£ç è´¨é‡é«˜
- âœ… å¯ç»´æŠ¤æ€§å¼º
- âœ… æµ‹è¯•è¦†ç›–å¥½
- âœ… æ–‡æ¡£é½å…¨

**å¯ä»¥æ­£å¼æŠ•å…¥ä½¿ç”¨ï¼** ğŸš€

