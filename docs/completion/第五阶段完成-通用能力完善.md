# ç¬¬äº”é˜¶æ®µå®Œæˆï¼šé€šç”¨èƒ½åŠ›å®Œå–„

## ğŸ“‹ å·²å®ŒæˆåŠŸèƒ½

### âœ… 1. å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

**æ–‡ä»¶**: `src/common/filters/http-exception.filter.ts`

**åŠŸèƒ½**:
- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¼‚å¸¸
- è‡ªåŠ¨è¯†åˆ« HTTP å¼‚å¸¸ã€æ™®é€šé”™è¯¯ã€æœªçŸ¥é”™è¯¯
- å¤„ç† `class-validator` éªŒè¯é”™è¯¯
- è®°å½•é”™è¯¯æ—¥å¿—
- è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”

**å“åº”æ ¼å¼**:
```json
{
  "code": 500,
  "msg": "é”™è¯¯ä¿¡æ¯",
  "data": null,
  "timestamp": "2024-01-01T00:00:00.000Z",
  "path": "/api/xxx"
}
```

---

### âœ… 2. å…¨å±€å“åº”æ‹¦æˆªå™¨

**æ–‡ä»¶**: `src/common/interceptors/transform.interceptor.ts`

**åŠŸèƒ½**:
- ç»Ÿä¸€åŒ…è£…å“åº”æ•°æ®
- è‡ªåŠ¨è®°å½•è¯·æ±‚æ—¥å¿—ï¼ˆæ–¹æ³•ã€è·¯å¾„ã€è€—æ—¶ï¼‰
- ä¿ç•™å·²æ ¼å¼åŒ–çš„å“åº”æ•°æ®

**å“åº”æ ¼å¼**:
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": { ... }
}
```

---

### âœ… 3. JWT è®¤è¯

#### 3.1 è®¤è¯ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/common/constants/auth.constant.ts` | è®¤è¯å¸¸é‡ |
| `src/common/interfaces/jwt-payload.interface.ts` | JWT Payload æ¥å£ |
| `src/common/strategies/jwt.strategy.ts` | JWT ç­–ç•¥ |
| `src/common/guards/jwt-auth.guard.ts` | JWT è®¤è¯å®ˆå« |
| `src/service/auth.service.ts` | è®¤è¯æœåŠ¡ |
| `src/controller/auth.controller.ts` | è®¤è¯ Controller |

#### 3.2 è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| POST | `/login` | ç”¨æˆ·ç™»å½• | å…¬å¼€ |
| GET | `/getInfo` | è·å–ç”¨æˆ·ä¿¡æ¯ | éœ€è®¤è¯ |
| POST | `/logout` | é€€å‡ºç™»å½• | éœ€è®¤è¯ |

#### 3.3 ç™»å½•æµç¨‹

1. ç”¨æˆ·æäº¤ç”¨æˆ·åå’Œå¯†ç 
2. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆæ˜¯å¦åœç”¨/åˆ é™¤ï¼‰
4. ç”Ÿæˆ JWT Token
5. æ›´æ–°ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼ˆIPã€æ—¶é—´ï¼‰
6. è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯

**ç™»å½•å“åº”**:
```json
{
  "code": 200,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "user": {
      "userId": 1,
      "userName": "admin",
      "nickName": "ç®¡ç†å‘˜",
      ...
    }
  }
}
```

---

### âœ… 4. æƒé™æ§åˆ¶

#### 4.1 è£…é¥°å™¨

| è£…é¥°å™¨ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `@Public()` | å…¬å¼€æ¥å£ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰ | `@Public()` |
| `@RequirePermissions()` | éœ€è¦æƒé™ | `@RequirePermissions('system:user:list')` |
| `@RequireRoles()` | éœ€è¦è§’è‰² | `@RequireRoles('admin')` |
| `@CurrentUser()` | è·å–å½“å‰ç”¨æˆ· | `@CurrentUser('userId')` |

#### 4.2 æƒé™å®ˆå«

**æ–‡ä»¶**: `src/common/guards/permissions.guard.ts`

**åŠŸèƒ½**:
- æ£€æŸ¥æ¥å£æ‰€éœ€æƒé™
- éªŒè¯ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æƒé™
- è¶…çº§ç®¡ç†å‘˜è‡ªåŠ¨é€šè¿‡
- æƒé™ä¸è¶³æŠ›å‡º 403 å¼‚å¸¸

#### 4.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
@Get('list')
@RequirePermissions('system:user:list')
async list(@Query() query: UserQueryDto) {
  // ...
}

@Post()
@RequirePermissions('system:user:add')
async add(
  @Body() dto: CreateUserDto,
  @CurrentUser('userName') userName: string,
) {
  // ...
}
```

---

### âœ… 5. æ“ä½œæ—¥å¿—

#### 5.1 æ—¥å¿—è£…é¥°å™¨

**æ–‡ä»¶**: `src/common/decorators/log.decorator.ts`

**åŠŸèƒ½**:
- å®šä¹‰æ—¥å¿—å…ƒæ•°æ®
- æ”¯æŒå¤šç§ä¸šåŠ¡ç±»å‹

**ä¸šåŠ¡ç±»å‹**:
```typescript
enum BusinessType {
  OTHER = 0,    // å…¶ä»–
  INSERT = 1,   // æ–°å¢
  UPDATE = 2,   // ä¿®æ”¹
  DELETE = 3,   // åˆ é™¤
  GRANT = 4,    // æˆæƒ
  EXPORT = 5,   // å¯¼å‡º
  IMPORT = 6,   // å¯¼å…¥
  FORCE = 7,    // å¼ºé€€
  GENCODE = 8,  // ç”Ÿæˆä»£ç 
  CLEAN = 9,    // æ¸…ç©ºæ•°æ®
}
```

#### 5.2 æ—¥å¿—æ‹¦æˆªå™¨

**æ–‡ä»¶**: `src/common/interceptors/log.interceptor.ts`

**åŠŸèƒ½**:
- è‡ªåŠ¨è®°å½•æ“ä½œæ—¥å¿—
- è®°å½•è¯·æ±‚å‚æ•°ï¼ˆå¯é€‰ï¼‰
- è®°å½•å“åº”æ•°æ®ï¼ˆå¯é€‰ï¼‰
- è¿‡æ»¤æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ç­‰ï¼‰
- è®°å½•æ“ä½œè€—æ—¶
- åŒºåˆ†æˆåŠŸ/å¤±è´¥æ—¥å¿—

#### 5.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
@Post()
@Log({ title: 'ç”¨æˆ·ç®¡ç†', businessType: BusinessType.INSERT })
async add(@Body() dto: CreateUserDto) {
  // ...
}

@Put()
@Log({ 
  title: 'ç”¨æˆ·ç®¡ç†', 
  businessType: BusinessType.UPDATE,
  isSaveRequestData: true,
  isSaveResponseData: false,
})
async edit(@Body() dto: UpdateUserDto) {
  // ...
}
```

**æ—¥å¿—è¾“å‡º**:
```
[æ“ä½œæ—¥å¿—] ç”¨æˆ·ç®¡ç† - admin - POST /system/user - 125ms - æˆåŠŸ
```

---

### âœ… 6. å…¨å±€é…ç½®

#### 6.1 AppModule é…ç½®

```typescript
@Module({
  providers: [
    // å…¨å±€ JWT è®¤è¯å®ˆå«
    {
      provide: APP_GUARD,
      useClass: JwtAuthGuard,
    },
    // å…¨å±€æƒé™å®ˆå«
    {
      provide: APP_GUARD,
      useClass: PermissionsGuard,
    },
    // å…¨å±€æ“ä½œæ—¥å¿—æ‹¦æˆªå™¨
    {
      provide: APP_INTERCEPTOR,
      useClass: LogInterceptor,
    },
  ],
})
```

#### 6.2 main.ts é…ç½®

```typescript
// å…¨å±€éªŒè¯ç®¡é“ï¼ˆå·²æœ‰ï¼‰
app.useGlobalPipes(new ValidationPipe({
  transform: true,
  whitelist: true,
  forbidNonWhitelisted: true,
}));

// å…¨å±€å“åº”æ‹¦æˆªå™¨ï¼ˆå·²æœ‰ï¼‰
app.useGlobalInterceptors(new TransformInterceptor());

// å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆå·²æœ‰ï¼‰
app.useGlobalFilters(new HttpExceptionFilter());
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Java ç‰ˆæœ¬ | NestJS ç‰ˆæœ¬ | çŠ¶æ€ |
|------|-----------|-------------|------|
| å¼‚å¸¸å¤„ç† | `GlobalExceptionHandler` | `HttpExceptionFilter` | âœ… |
| å“åº”åŒ…è£… | `AjaxResult` | `ResponseDto` + `TransformInterceptor` | âœ… |
| JWT è®¤è¯ | Spring Security + JWT | Passport + JWT | âœ… |
| æƒé™æ§åˆ¶ | `@PreAuthorize` | `@RequirePermissions` + `PermissionsGuard` | âœ… |
| æ“ä½œæ—¥å¿— | `@Log` + AOP | `@Log` + `LogInterceptor` | âœ… |
| å½“å‰ç”¨æˆ· | `SecurityUtils.getUsername()` | `@CurrentUser()` | âœ… |

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ auth.constant.ts          # è®¤è¯å¸¸é‡
â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”œâ”€â”€ public.decorator.ts       # å…¬å¼€æ¥å£è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ current-user.decorator.ts # å½“å‰ç”¨æˆ·è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ permissions.decorator.ts  # æƒé™è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ roles.decorator.ts        # è§’è‰²è£…é¥°å™¨
â”‚   â”‚   â””â”€â”€ log.decorator.ts          # æ—¥å¿—è£…é¥°å™¨
â”‚   â”œâ”€â”€ filters/
â”‚   â”‚   â””â”€â”€ http-exception.filter.ts  # å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”œâ”€â”€ jwt-auth.guard.ts         # JWT è®¤è¯å®ˆå«
â”‚   â”‚   â”œâ”€â”€ permissions.guard.ts      # æƒé™å®ˆå«
â”‚   â”‚   â””â”€â”€ roles.guard.ts            # è§’è‰²å®ˆå«
â”‚   â”œâ”€â”€ interceptors/
â”‚   â”‚   â”œâ”€â”€ transform.interceptor.ts  # å“åº”æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ log.interceptor.ts        # æ—¥å¿—æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ interfaces/
â”‚   â”‚   â””â”€â”€ jwt-payload.interface.ts  # JWT Payload æ¥å£
â”‚   â””â”€â”€ strategies/
â”‚       â””â”€â”€ jwt.strategy.ts           # JWT ç­–ç•¥
â”‚
â”œâ”€â”€ service/
â”‚   â””â”€â”€ auth.service.ts               # è®¤è¯æœåŠ¡
â”‚
â””â”€â”€ controller/
    â”œâ”€â”€ auth.controller.ts            # è®¤è¯ Controller
    â””â”€â”€ dto/
        â””â”€â”€ login.dto.ts              # ç™»å½• DTO
```

---

## âœ… å·²åº”ç”¨åˆ° UserController

### æƒé™æ§åˆ¶

```typescript
@Get('list')
@RequirePermissions('system:user:list')
async list() { ... }

@Post()
@RequirePermissions('system:user:add')
async add() { ... }

@Put()
@RequirePermissions('system:user:edit')
async edit() { ... }

@Delete(':userIds')
@RequirePermissions('system:user:remove')
async remove() { ... }
```

### æ“ä½œæ—¥å¿—

```typescript
@Post()
@Log({ title: 'ç”¨æˆ·ç®¡ç†', businessType: BusinessType.INSERT })
async add() { ... }

@Put()
@Log({ title: 'ç”¨æˆ·ç®¡ç†', businessType: BusinessType.UPDATE })
async edit() { ... }

@Delete(':userIds')
@Log({ title: 'ç”¨æˆ·ç®¡ç†', businessType: BusinessType.DELETE })
async remove() { ... }
```

### å½“å‰ç”¨æˆ·

```typescript
@Post()
async add(
  @Body() dto: CreateUserDto,
  @CurrentUser('userName') userName: string,
) {
  dto.createBy = userName;
  // ...
}

@Delete(':userIds')
async remove(
  @Param('userIds') userIds: string,
  @CurrentUser('userId') currentUserId: number,
) {
  // æ£€æŸ¥æ˜¯å¦åˆ é™¤å½“å‰ç”¨æˆ·
  if (userIdArray.includes(currentUserId)) {
    throw new BadRequestException('å½“å‰ç”¨æˆ·ä¸èƒ½åˆ é™¤');
  }
  // ...
}
```

---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. ç™»å½•è·å– Token

```bash
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{
    "userName": "admin",
    "password": "admin123"
  }'
```

### 2. ä½¿ç”¨ Token è®¿é—®æ¥å£

```bash
curl -X GET http://localhost:3000/system/user/list \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

```bash
curl -X GET http://localhost:3000/getInfo \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸ“ å¾…å®Œå–„åŠŸèƒ½

### é«˜ä¼˜å…ˆçº§

1. **æ•°æ®æƒé™è¿‡æ»¤**
   - éƒ¨é—¨æ•°æ®æƒé™
   - è‡ªå®šä¹‰æ•°æ®æƒé™
   - æ•°æ®èŒƒå›´è¿‡æ»¤

2. **æƒé™å®Œå–„**
   - ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·æƒé™
   - æƒé™ç¼“å­˜ï¼ˆRedisï¼‰
   - è§’è‰²æƒé™ç®¡ç†

3. **æ—¥å¿—æŒä¹…åŒ–**
   - åˆ›å»ºæ“ä½œæ—¥å¿—è¡¨
   - ä¿å­˜æ—¥å¿—åˆ°æ•°æ®åº“
   - æ—¥å¿—æŸ¥è¯¢æ¥å£

### ä¸­ä¼˜å…ˆçº§

4. **éªŒè¯ç **
   - å›¾å½¢éªŒè¯ç ç”Ÿæˆ
   - éªŒè¯ç éªŒè¯
   - éªŒè¯ç ç¼“å­˜

5. **Token ç®¡ç†**
   - Token é»‘åå•ï¼ˆRedisï¼‰
   - Token åˆ·æ–°æœºåˆ¶
   - å•ç‚¹ç™»å½•

6. **IP è·å–**
   - çœŸå® IP è·å–
   - IP å½’å±åœ°æŸ¥è¯¢

---

## ğŸ‰ æ€»ç»“

**ç¬¬äº”é˜¶æ®µï¼šé€šç”¨èƒ½åŠ›å®Œå–„å·²å®Œæˆï¼**

- âœ… å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
- âœ… å…¨å±€å“åº”æ‹¦æˆªå™¨
- âœ… JWT è®¤è¯ï¼ˆç™»å½•ã€Token éªŒè¯ï¼‰
- âœ… æƒé™æ§åˆ¶ï¼ˆGuard + Decoratorï¼‰
- âœ… æ“ä½œæ—¥å¿—ï¼ˆLog Interceptorï¼‰
- âœ… å½“å‰ç”¨æˆ·è·å–
- âœ… å·²åº”ç”¨åˆ° UserController

**æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œé¡¹ç›®åŸºæœ¬å¯ç”¨ï¼**

**ä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­å®Œå–„**ï¼š
- æ•°æ®æƒé™è¿‡æ»¤
- æƒé™ä»æ•°æ®åº“åŠ è½½
- æ—¥å¿—æŒä¹…åŒ–
- éªŒè¯ç åŠŸèƒ½
- å…¶ä»–æ¨¡å—è¿ç§»ï¼ˆéƒ¨é—¨ã€è§’è‰²ã€èœå•ç­‰ï¼‰

