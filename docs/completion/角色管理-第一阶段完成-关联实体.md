# 角色管理 - 第一阶段完成：关联实体准备

## ✅ 完成时间
2025-12-23

## 🎯 阶段目标
创建角色相关的关联表实体，为后续 Mapper 层和 Service 层迁移做准备。

---

## 📁 已创建文件

### 1. SysRoleMenu 实体
**文件**：`src/domain/entities/sys-role-menu.entity.ts`

**说明**：
- 角色和菜单关联表
- 用于维护角色与菜单（权限）的多对多关联关系
- 通过此表可以为角色分配菜单权限
- 联合主键：`roleId` + `menuId`

**字段**：
```typescript
- roleId: number  // 角色ID（主键）
- menuId: number  // 菜单ID（主键）
```

**对应数据库表**：`sys_role_menu`

---

### 2. SysRoleDept 实体
**文件**：`src/domain/entities/sys-role-dept.entity.ts`

**说明**：
- 角色和部门关联表
- 用于维护角色与部门的多对多关联关系
- 用于角色的自定义数据权限（`dataScope = 2`）
- 通过此表可以为角色指定可以访问哪些部门的数据
- 联合主键：`roleId` + `deptId`

**字段**：
```typescript
- roleId: number  // 角色ID（主键）
- deptId: number  // 部门ID（主键）
```

**对应数据库表**：`sys_role_dept`

---

## 🔧 已更新文件

### 1. 实体导出文件
**文件**：`src/domain/entities/index.ts`

**更新内容**：
```typescript
export * from './sys-role-menu.entity';
export * from './sys-role-dept.entity';
```

---

### 2. Mapper 模块
**文件**：`src/mapper/mapper.module.ts`

**更新内容**：
```typescript
// 导入新实体
import { 
  SysUser, 
  SysDept, 
  SysRole, 
  SysMenu, 
  SysPost, 
  SysOperLog,
  SysRoleMenu,  // ✅ 新增
  SysRoleDept,  // ✅ 新增
} from '../domain/entities';

// 注册到 TypeORM
TypeOrmModule.forFeature([
  SysUser,
  SysDept,
  SysRole,
  SysMenu,
  SysPost,
  SysOperLog,
  SysRoleMenu,  // ✅ 新增
  SysRoleDept,  // ✅ 新增
])
```

---

## 📊 实体对比

| 实体名称 | Java 类 | TypeScript 类 | 数据库表 | 用途 |
|---------|---------|--------------|---------|------|
| 角色菜单关联 | `SysRoleMenu.java` | `SysRoleMenu` | `sys_role_menu` | 角色权限分配 |
| 角色部门关联 | `SysRoleDept.java` | `SysRoleDept` | `sys_role_dept` | 自定义数据权限 |

---

## 🔗 关联关系说明

### 角色 ↔ 菜单（通过 SysRoleMenu）
```
SysRole (1) ←→ (N) SysRoleMenu (N) ←→ (1) SysMenu

一个角色可以有多个菜单权限
一个菜单可以分配给多个角色
```

**使用场景**：
- 角色权限管理
- 为角色分配菜单（功能）权限
- 查询角色拥有的所有菜单
- 查询菜单被哪些角色使用

---

### 角色 ↔ 部门（通过 SysRoleDept）
```
SysRole (1) ←→ (N) SysRoleDept (N) ←→ (1) SysDept

一个角色可以访问多个部门的数据
一个部门的数据可以被多个角色访问
```

**使用场景**：
- 数据权限管理
- 为角色指定可访问的部门范围（自定义数据权限）
- 当角色的 `dataScope = 2`（自定义数据权限）时生效
- 查询角色可以访问哪些部门
- 查询部门数据可以被哪些角色访问

---

## 🎨 TypeORM 特性使用

### 联合主键
两个实体都使用了联合主键：

```typescript
@Entity('sys_role_menu')
export class SysRoleMenu {
  @PrimaryColumn({ name: 'role_id', type: 'bigint' })
  roleId: number;

  @PrimaryColumn({ name: 'menu_id', type: 'bigint' })
  menuId: number;
}
```

**说明**：
- 使用 `@PrimaryColumn()` 装饰器定义联合主键
- 保证 `(roleId, menuId)` 的组合唯一性
- 防止同一角色多次分配同一菜单

---

### 命名策略
遵循若依原版的命名规范：

```typescript
// 数据库列名：下划线命名
@PrimaryColumn({ name: 'role_id', ... })

// TypeScript 属性名：驼峰命名
roleId: number;
```

**自动映射**：
- TypeORM 会自动处理 `role_id` ↔ `roleId` 的转换
- 代码中使用驼峰命名，数据库使用下划线命名

---

## ✅ 验证结果

### 编译验证
```bash
npm run build
✅ 编译成功，无错误
```

### 文件结构
```
src/domain/entities/
├── base.entity.ts
├── sys-user.entity.ts
├── sys-dept.entity.ts
├── sys-role.entity.ts
├── sys-menu.entity.ts
├── sys-post.entity.ts
├── sys-oper-log.entity.ts
├── sys-role-menu.entity.ts   ✅ 新增
├── sys-role-dept.entity.ts   ✅ 新增
└── index.ts                   ✅ 已更新
```

---

## 📝 与用户管理的对比

| 对比项 | 用户管理 | 角色管理 |
|--------|---------|---------|
| 关联表数量 | 2 个 | 2 个 |
| 用户角色关联 | `SysUserRole` | - |
| 用户岗位关联 | `SysUserPost` | - |
| 角色菜单关联 | - | `SysRoleMenu` ✅ |
| 角色部门关联 | - | `SysRoleDept` ✅ |
| 联合主键 | userId + roleId / postId | roleId + menuId / deptId |

---

## 🚀 下一步：第二阶段

### 目标
创建角色相关的 Repository（数据访问层）

### 需要创建的 Repository
1. **role-menu.repository.ts** - 角色菜单关联 Repository
2. **role-dept.repository.ts** - 角色部门关联 Repository
3. 补充 **role.repository.ts** - 角色 Repository（已存在，需补充方法）

### 预计工作量
2-3 小时

---

## 📊 阶段总结

| 任务 | 状态 | 耗时 |
|------|------|------|
| 创建 SysRoleMenu 实体 | ✅ 完成 | 10 分钟 |
| 创建 SysRoleDept 实体 | ✅ 完成 | 10 分钟 |
| 更新实体导出文件 | ✅ 完成 | 5 分钟 |
| 更新 MapperModule | ✅ 完成 | 5 分钟 |
| 编译验证 | ✅ 完成 | 5 分钟 |
| **总计** | **✅ 完成** | **35 分钟** |

---

**第一阶段完成！可以开始第二阶段：Mapper 层迁移** 🎉

