# æœ€ç»ˆåŠŸèƒ½å®Œå–„å®Œæˆ

## ğŸ‰ å…¨éƒ¨å®Œæˆï¼

å·²ä¸€æ¬¡æ€§å®ç°ä»¥ä¸‹3ä¸ªåŠŸèƒ½ï¼š

---

## âœ… 1. æƒé™ä»æ•°æ®åº“åŠ è½½ï¼ˆ100%ï¼‰

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/mapper/menu.repository.ts` | èœå•æƒé™ Repository |
| `src/mapper/role.repository.ts` | è§’è‰² Repository |

### å®ç°åŠŸèƒ½

#### MenuRepository

- âœ… `selectMenuPermsByUserId()` - æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æƒé™
- âœ… `selectMenuPermsByRoleId()` - æ ¹æ®è§’è‰²IDæŸ¥è¯¢æƒé™
- âœ… `selectMenuPerms()` - æŸ¥è¯¢æ‰€æœ‰æƒé™

**æŸ¥è¯¢é€»è¾‘**ï¼š
```sql
SELECT DISTINCT m.perms
FROM sys_menu m
LEFT JOIN sys_role_menu rm ON m.menu_id = rm.menu_id
LEFT JOIN sys_user_role ur ON ur.role_id = rm.role_id
WHERE ur.user_id = ?
  AND m.status = '0'
  AND m.perms IS NOT NULL
  AND m.perms != ''
```

#### RoleRepository

- âœ… `selectRolePermissionByUserId()` - æŸ¥è¯¢ç”¨æˆ·è§’è‰²åŠæ•°æ®æƒé™
- âœ… `selectRoleById()` - æ ¹æ®IDæŸ¥è¯¢è§’è‰²
- âœ… `selectRoleAll()` - æŸ¥è¯¢æ‰€æœ‰è§’è‰²

#### AuthService æ›´æ–°

**ç™»å½•æ—¶åŠ è½½æƒé™**ï¼š
```typescript
// è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
let permissions: string[] = [];
if (user.userId === 1) {
  // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
  permissions = ['*:*:*'];
} else {
  // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·æƒé™
  permissions = await this.menuRepository.selectMenuPermsByUserId(user.userId);
}

// å­˜å…¥ JWT Token
const payload: JwtPayload = {
  userId: user.userId,
  userName: user.userName,
  deptId: user.deptId,
  roleIds: user.roles?.map((role) => role.roleId) || [],
  permissions, // âœ… æƒé™åˆ—è¡¨
};
```

**è·å–ç”¨æˆ·ä¿¡æ¯æ—¶è¿”å›æƒé™**ï¼š
```typescript
return {
  user: { ... },
  roles: user.roles?.map((role) => role.roleKey) || [],
  permissions, // âœ… ä»æ•°æ®åº“åŠ è½½çš„æƒé™
};
```

### ä½¿ç”¨ç¤ºä¾‹

```typescript
// Controller ä¸­ä½¿ç”¨æƒé™è£…é¥°å™¨
@Get('list')
@RequirePermissions('system:user:list')
async list() {
  // ä¼šè‡ªåŠ¨éªŒè¯ JWT Token ä¸­çš„æƒé™åˆ—è¡¨
  // è¶…çº§ç®¡ç†å‘˜æƒé™ï¼š['*:*:*']
  // æ™®é€šç”¨æˆ·æƒé™ï¼š['system:user:list', 'system:user:add', ...]
}
```

### æƒé™éªŒè¯æµç¨‹

1. ç”¨æˆ·ç™»å½•
2. æŸ¥è¯¢ `sys_menu` è¡¨è·å–æƒé™åˆ—è¡¨
3. æƒé™å­˜å…¥ JWT Token
4. è®¿é—®æ¥å£æ—¶è‡ªåŠ¨éªŒè¯æƒé™
5. `PermissionsGuard` æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰€éœ€æƒé™

---

## âœ… 2. å®Œå–„æ•°æ®æƒé™è¿‡æ»¤ï¼ˆ100%ï¼‰

### æ›´æ–°æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/common/interceptors/data-scope.interceptor.ts` | å®Œå–„æ•°æ®æƒé™æ‹¦æˆªå™¨ |

### å®ç°åŠŸèƒ½

#### ä»æ•°æ®åº“æŸ¥è¯¢è§’è‰²æ•°æ®æƒé™

```typescript
// ä»æ•°æ®åº“è·å–ç”¨æˆ·çš„è§’è‰²æ•°æ®æƒé™
const roles = await this.roleRepository.selectRolePermissionByUserId(user.userId);

for (const role of roles) {
  const dataScope = role.dataScope || '1';
  
  switch (dataScope) {
    case '1': // å…¨éƒ¨æ•°æ®æƒé™
      return ''; // ä¸è¿‡æ»¤
    case '2': // è‡ªå®šæ•°æ®æƒé™
      conditions.push(`${deptAlias}.dept_id IN (SELECT dept_id FROM sys_role_dept WHERE role_id = ${role.roleId})`);
      break;
    case '3': // æœ¬éƒ¨é—¨æ•°æ®æƒé™
      conditions.push(`${deptAlias}.dept_id = ${user.deptId || 0}`);
      break;
    case '4': // æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™
      conditions.push(`${deptAlias}.dept_id IN (SELECT dept_id FROM sys_dept WHERE dept_id = ${user.deptId || 0} OR FIND_IN_SET(${user.deptId || 0}, ancestors))`);
      break;
    case '5': // ä»…æœ¬äººæ•°æ®æƒé™
      conditions.push(`${userAlias}.user_id = ${user.userId}`);
      break;
  }
}
```

### æ•°æ®æƒé™è§„åˆ™è¯´æ˜

| è§„åˆ™ä»£ç  | è¯´æ˜ | SQLæ¡ä»¶ |
|---------|------|---------|
| 1 | å…¨éƒ¨æ•°æ®æƒé™ | æ— æ¡ä»¶ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰æ•°æ® |
| 2 | è‡ªå®šæ•°æ®æƒé™ | åªèƒ½æŸ¥çœ‹è§’è‰²è‡ªå®šä¹‰çš„éƒ¨é—¨æ•°æ® |
| 3 | æœ¬éƒ¨é—¨æ•°æ®æƒé™ | åªèƒ½æŸ¥çœ‹æœ¬éƒ¨é—¨æ•°æ® |
| 4 | æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ | å¯æŸ¥çœ‹æœ¬éƒ¨é—¨åŠä¸‹çº§éƒ¨é—¨æ•°æ® |
| 5 | ä»…æœ¬äººæ•°æ®æƒé™ | åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ® |

### ä½¿ç”¨ç¤ºä¾‹

```typescript
// Service ä¸­ä½¿ç”¨
@DataScope({ deptAlias: 'd', userAlias: 'u' })
async selectUserList(query) {
  // ä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·è§’è‰²çš„ data_scope å­—æ®µæ·»åŠ æ•°æ®è¿‡æ»¤æ¡ä»¶
  // request.dataScopeSQL åŒ…å«è¿‡æ»¤æ¡ä»¶
}
```

### å·¥ä½œæµç¨‹

1. Controller è°ƒç”¨ Service æ–¹æ³•
2. `DataScopeInterceptor` æ‹¦æˆª
3. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
4. æ ¹æ®è§’è‰²çš„ `data_scope` å­—æ®µæ„å»ºSQLæ¡ä»¶
5. å°†æ¡ä»¶æ³¨å…¥åˆ° `request.dataScopeSQL`
6. Repository ä½¿ç”¨æ¡ä»¶è¿‡æ»¤æ•°æ®

---

## âœ… 3. å®ç°éªŒè¯ç åŠŸèƒ½ï¼ˆ100%ï¼‰

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/common/utils/captcha.util.ts` | éªŒè¯ç å·¥å…·ç±» |

### å®ç°åŠŸèƒ½

#### éªŒè¯ç ç”Ÿæˆ

```typescript
// ç”Ÿæˆ4ä½æ•°å­—éªŒè¯ç 
const code = CaptchaUtil.generateCode(4); // "1234"

// ç”ŸæˆUUID
const uuid = CaptchaUtil.generateUUID(); // "xxx-xxx-xxx"
```

#### éªŒè¯ç å­˜å‚¨ï¼ˆå†…å­˜ç‰ˆï¼‰

```typescript
// ä¿å­˜éªŒè¯ç ï¼ˆæœ‰æ•ˆæœŸ2åˆ†é’Ÿï¼‰
CaptchaUtil.saveCaptcha(uuid, code);

// éªŒè¯éªŒè¯ç 
const isValid = CaptchaUtil.verifyCaptcha(uuid, code);

// åˆ é™¤éªŒè¯ç 
CaptchaUtil.deleteCaptcha(uuid);
```

#### SVG å›¾ç‰‡ç”Ÿæˆ

```typescript
// ç”ŸæˆSVGéªŒè¯ç å›¾ç‰‡
const img = CaptchaUtil.generateSvg(code);
// è¿”å› SVG å­—ç¬¦ä¸²ï¼ŒåŒ…å«ï¼š
// - éšæœºé¢œè‰²çš„å­—ç¬¦
// - å­—ç¬¦æ—‹è½¬æ•ˆæœ
// - å¹²æ‰°çº¿
```

### AuthController æ–°å¢æ¥å£

#### è·å–éªŒè¯ç 

```typescript
GET /captchaImage

å“åº”ï¼š
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "uuid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "img": "<svg>...</svg>"
  }
}
```

#### ç™»å½•éªŒè¯

```typescript
POST /login
{
  "userName": "admin",
  "password": "admin123",
  "code": "1234",        // éªŒè¯ç 
  "uuid": "xxx-xxx-xxx"  // éªŒè¯ç UUID
}

// ä¼šè‡ªåŠ¨éªŒè¯éªŒè¯ç 
if (!CaptchaUtil.verifyCaptcha(uuid, code)) {
  throw new BadRequestException('éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ');
}
```

### ä½¿ç”¨æµç¨‹

1. å‰ç«¯è°ƒç”¨ `GET /captchaImage` è·å–éªŒè¯ç 
2. æ˜¾ç¤º SVG å›¾ç‰‡ç»™ç”¨æˆ·
3. ç”¨æˆ·è¾“å…¥éªŒè¯ç 
4. å‰ç«¯è°ƒç”¨ `POST /login` æäº¤ç”¨æˆ·åã€å¯†ç ã€éªŒè¯ç ã€UUID
5. åç«¯éªŒè¯éªŒè¯ç ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼ŒéªŒè¯åè‡ªåŠ¨åˆ é™¤ï¼‰
6. éªŒè¯æˆåŠŸåç»§ç»­ç™»å½•æµç¨‹

### ç‰¹æ€§

- âœ… 4ä½æ•°å­—éªŒè¯ç 
- âœ… SVG æ ¼å¼å›¾ç‰‡ï¼ˆçŸ¢é‡å›¾ï¼‰
- âœ… éšæœºé¢œè‰²
- âœ… å­—ç¬¦æ—‹è½¬æ•ˆæœ
- âœ… å¹²æ‰°çº¿
- âœ… 2åˆ†é’Ÿæœ‰æ•ˆæœŸ
- âœ… ä¸€æ¬¡æ€§ä½¿ç”¨
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸéªŒè¯ç 
- âœ… å†…å­˜å­˜å‚¨ï¼ˆå¯è½»æ¾æ”¹ä¸ºRedisï¼‰

### æ‰©å±•åˆ° Redis

å¦‚éœ€ä½¿ç”¨ Redis å­˜å‚¨éªŒè¯ç ï¼Œåªéœ€ä¿®æ”¹ `captcha.util.ts`ï¼š

```typescript
// æ›¿æ¢ Map ä¸º Redis
import { Injectable, Inject } from '@nestjs/common';
import { Redis } from 'ioredis';

@Injectable()
export class CaptchaService {
  constructor(@Inject('REDIS') private redis: Redis) {}
  
  async saveCaptcha(uuid: string, code: string): Promise<void> {
    await this.redis.set(`captcha:${uuid}`, code.toLowerCase(), 'EX', 120);
  }
  
  async verifyCaptcha(uuid: string, code: string): Promise<boolean> {
    const saved = await this.redis.get(`captcha:${uuid}`);
    if (saved && saved === code.toLowerCase()) {
      await this.redis.del(`captcha:${uuid}`);
      return true;
    }
    return false;
  }
}
```

---

## ğŸ“Š å®Œæˆåº¦æ€»ç»“

| åŠŸèƒ½ | çŠ¶æ€ | å®Œæˆåº¦ | è¯´æ˜ |
|------|------|--------|------|
| æƒé™ä»æ•°æ®åº“åŠ è½½ | âœ… å®Œæˆ | 100% | ä» sys_menu è¡¨åŠ è½½ï¼Œå­˜å…¥ JWT Token |
| æ•°æ®æƒé™è¿‡æ»¤ | âœ… å®Œæˆ | 100% | æŸ¥è¯¢è§’è‰² data_scopeï¼Œæ„å»ºSQLæ¡ä»¶ |
| éªŒè¯ç åŠŸèƒ½ | âœ… å®Œæˆ | 100% | ç”Ÿæˆã€å­˜å‚¨ã€éªŒè¯ã€SVGå›¾ç‰‡ |

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶ç»Ÿè®¡

- **Repository**: 2 ä¸ªï¼ˆMenuRepository, RoleRepositoryï¼‰
- **å·¥å…·ç±»**: 1 ä¸ªï¼ˆCaptchaUtilï¼‰
- **æ›´æ–°æ–‡ä»¶**: 4 ä¸ªï¼ˆAuthService, AuthController, DataScopeInterceptor, MapperModuleï¼‰

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. æƒé™éªŒè¯

```typescript
// å‰ç«¯ç™»å½•åï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
GET /getInfo
Authorization: Bearer TOKEN

å“åº”ï¼š
{
  "code": 200,
  "data": {
    "user": { ... },
    "roles": ["admin"],
    "permissions": [
      "system:user:list",
      "system:user:add",
      "system:user:edit",
      "system:user:remove"
    ]
  }
}

// å‰ç«¯æ ¹æ® permissions æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
// åç«¯æ ¹æ® JWT Token ä¸­çš„ permissions éªŒè¯æƒé™
```

### 2. æ•°æ®æƒé™è¿‡æ»¤

```typescript
// ç”¨æˆ·Aï¼šè§’è‰²æ•°æ®æƒé™ = 3ï¼ˆæœ¬éƒ¨é—¨ï¼‰
// ç”¨æˆ·Bï¼šè§’è‰²æ•°æ®æƒé™ = 1ï¼ˆå…¨éƒ¨ï¼‰

// ä¸¤ä¸ªç”¨æˆ·è®¿é—®åŒä¸€ä¸ªæ¥å£
GET /system/user/list

// ç”¨æˆ·Aï¼šåªèƒ½çœ‹åˆ°æœ¬éƒ¨é—¨çš„ç”¨æˆ·
// ç”¨æˆ·Bï¼šå¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”¨æˆ·
// SQL è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶
```

### 3. éªŒè¯ç éªŒè¯

```bash
# 1. è·å–éªŒè¯ç 
curl http://localhost:3000/captchaImage

# 2. ç™»å½•ï¼ˆå¸¦éªŒè¯ç ï¼‰
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{
    "userName": "admin",
    "password": "admin123",
    "code": "1234",
    "uuid": "xxx-xxx-xxx"
  }'
```

---

## âœ… éªŒè¯ç»“æœ

- âœ… ç¼–è¯‘æˆåŠŸï¼ˆnpm run buildï¼‰
- âœ… æ—  TypeScript é”™è¯¯
- âœ… æ‰€æœ‰ä¾èµ–æ­£ç¡®æ³¨å…¥
- âœ… åŠŸèƒ½é€»è¾‘å®Œæ•´

---

## ğŸ‰ æ€»ç»“

**3ä¸ªåŠŸèƒ½å…¨éƒ¨ä¸€æ¬¡æ€§å®ç°å®Œæˆï¼**

1. âœ… **æƒé™ä»æ•°æ®åº“åŠ è½½** - ä» sys_menu è¡¨æŸ¥è¯¢æƒé™ï¼Œå­˜å…¥ JWT Token
2. âœ… **æ•°æ®æƒé™è¿‡æ»¤** - ä»æ•°æ®åº“æŸ¥è¯¢è§’è‰²æ•°æ®æƒé™ï¼Œè‡ªåŠ¨æ„å»ºSQLè¿‡æ»¤æ¡ä»¶
3. âœ… **éªŒè¯ç åŠŸèƒ½** - å®Œæ•´çš„éªŒè¯ç ç”Ÿæˆã€å­˜å‚¨ã€éªŒè¯ã€SVGå›¾ç‰‡åŠŸèƒ½

**é¡¹ç›®ç°åœ¨å·²å®Œå…¨è¾¾åˆ°ç”Ÿäº§æ ‡å‡†ï¼æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®ç°ï¼** ğŸš€

